$(function(){new xsUserLibBookClick().Init()});function xsUserLibBookClick(){var b;this.Init=function(){var c=this;b=$("#UserLibBookClick");if(b.exists()){b.button();c.RefreshText();b.click(function(){var d=$(this).attr("BookId");$.ajax({type:"POST",url:"/UserLibBookButtonClick",data:({BookId:d}),success:function(e){var f=xsJsonParse(e);if(f.checked){b.attr("checked","checked")}else{b.removeAttr("checked")}c.RefreshText()},beforeSend:function(){}})})}},this.RefreshText=function(){var c=this;if(b.attr("checked")=="checked"){b.button("option","label","Удалить&nbsp;из&nbsp;моей&nbsp;библиотеки")}else{b.button("option","label","Добавить&nbsp;в&nbsp;мою&nbsp;библиотеку")}}}$(function(){var c=$("#BookStatus");if(c.exists()){var b=c.attr("BookId");c.change(function(){$.ajax({type:"POST",url:"/BookChangeStatus",data:({BookId:b,Code:c.val()}),success:function(d){$("[jq=BookStatusSaveStatus]").html("Сохранено");var e=xsJsonParse(d)},beforeSend:function(){$("[jq=BookStatusSaveStatus]").html("Сохранение...")}})})}});$(function(){new xsBookShowSectionTitles().Init()});function xsBookShowSectionTitles(){var b;this.Init=function(){var c=this;$("[jq=RedirectBook]").click(function(){var d=Date.now();c.Dialog=$("<div />",{html:'Перед объединением прочитайте!!<br /> Текущая книга перестанет показыватся в общем списке автора. <br />  В списке автора останется книга к которой вы присоединяете. <br /> Страницы онлайн чтения не переносятся!!. <br /> Введите ID книги к которой вы присоединяете текущую книгу: <br /> <input name="Bookid" type="text" value=""> <div> <input name="MergeComments" id="MergeComments'+d+'" type="checkbox" ><label for="MergeComments'+d+'">Перенести комментарии</label></div><div> <input name="MergeRate" id="MergeRate'+d+'" type="checkbox" ><label for="MergeRate'+d+'">Перенести оценки</label></div><div> <input name="MergeBookFile" id="MergeBookFile'+d+'" type="checkbox"><label for="MergeBookFile'+d+'">Перенести файлы книг</label></div><div> <input name="MergeUserStatus" id="MergeUserStatus'+d+'" type="checkbox"><label for="MergeUserStatus'+d+'">Переместить метки пользователей: прочитали, хотят прочитать и т.д.</label></div>'}).dialog({width:"400px",modal:true,resizable:false,title:"Заменить эту книгу",buttons:{"Заменить":function(){var e=$(this);var f=c.Dialog.find("[name=Bookid]").val();$.ajax({url:"/SaveBookRedirect",type:"POST",data:({RedirectOnBookId:f,RedirectFromBookid:xsJsDataGet("BookId"),MergeComments:c.Dialog.find("[name=MergeComments]:checked").val(),MergeRate:c.Dialog.find("[name=MergeRate]:checked").val(),MergeBookFile:c.Dialog.find("[name=MergeBookFile]:checked").val(),MergeUserStatus:c.Dialog.find("[name=MergeUserStatus]:checked").val()}),success:function(g){var h=xsJsonParse(g);ReloadPage()}})},"Отмена":function(){$(this).dialog("close")}}})})}}$(function(){new xsBookSimilar().Init()});function xsBookSimilar(){this.Init=function(){var b=this;$("[jq=BookSimilarAdd]").click(function(){b.Dialog=$("<div />",{html:'<input jq="BookId" style="width:200px"/>'});b.Dialog.dialog({autoOpen:true,width:300,resizable:false,modal:true,title:"Добавить похожую книгу по ID",buttons:{"Добавить":function(){$.ajax({url:"/BookSimilarAdd",data:{BookId:b.Dialog.find("[jq=BookId]").val(),BookId2:xsJsDataGet("BookId")},success:function(c){var d=xsJsonParse(c);b.Load();b.Dialog.dialog("close")}})},"Отмена":function(){$(this).dialog("close")}}})});$("[jq=BookSimilarContent]").find("[jq=BookSimilar]").each(function(){var c=new xsBookSimilarItem();c.Item=$(this);c.BookId2=xsJsDataGet("BookId");c.Init()})};this.Load=function(){$.ajax({url:"/BookSimilarLoad",data:{BookId:xsJsDataGet("BookId")},success:function(b){var d=xsJsonParse(b);$("[jq=BookSimilarContent]").html(d.Content);var c=new xsBookSimilarItem();c.Item=$(this);c.BookId2=xsJsDataGet("BookId");c.Init()}})}}function xsBookSimilarItem(){this.Init=function(){var b=this;b.BookId=b.Item.attr("BookId");b.VoteButtons()};this.VoteButtons=function(){var d=this;var b=d.Item.find("[jq=up]");var f=d.Item.find("[jq=down]");d.upClass="orange_desc2";d.downClass="blue_desc4";var e=function(){c.off("click");var g=$(this).attr("jq");if(g=="up"){if(!$(this).attr("enabled")){$(this).removeAttr("class").addClass(d.downClass);$(this).attr("enabled","true");f.removeAttr("enabled").removeAttr("class").addClass(d.upClass)}else{$(this).removeAttr("class").addClass(d.upClass);$(this).removeAttr("enabled")}}else{if(g=="down"){if(!$(this).attr("enabled")){$(this).removeAttr("class").addClass(d.downClass);$(this).attr("enabled","true");b.removeAttr("enabled").removeAttr("class").addClass(d.upClass)}else{$(this).removeAttr("class").addClass(d.upClass);$(this).removeAttr("enabled")}}}$.ajax({url:"/BookSimilarVote",data:{BookId2:d.BookId2,BookId:d.BookId,Vote:g},success:function(h){c.on("click",e);var i=xsJsonParse(h)}})};var c=d.Item.find("[jq=up],[jq=down]");c.on("click",e)}}$(function(){new xsBookKeywordAdd().Init();new xsBookKeywordVote().Init();new xsBookFiles().Init();new xsBookCover().Init();new xsBookReadContinue().Init()});function xsBookAudio(){this.Init=function(c,d){var b=this}}$(function(){var b=xsJsDataGet("BookId");if(b){new xsBookVote().Init();$("[jq=DeleteBook]").click(function(){$("<div />",{html:'Если вы желаете, чтобы книга больше не появлялась в открытом доступе, то лучше нажмите "Закрыть доступ", иначе книгу запросто смогу добавить еще раз.'}).dialog({resizable:false,modal:true,title:"",width:300,buttons:[{"class":"deletebutton",text:"Удалить",click:function(){var c=$(this);$.ajax({url:"/BookDeleteHide",data:{BookId:b},success:function(d){var e=xsJsonParse(d);xsMessage("Книга удалена <br />"+e.Content,"");c.dialog("close")}})}},{"class":"hidebutton",text:"Закрыть доступ",click:function(){var c=$(this);$.ajax({url:"/BookSecretHide",data:{BookId:b},success:function(d){var e=xsJsonParse(d);ReloadPage()}})}},{"class":"cancelbutton",text:"Нет",click:function(){$(this).dialog("close")}}]});$(".deletebutton").focus()});$("[jq=BookSecretHide]").click(function(){$("<div />",{html:'Сообщите причину закрытия:<br><input type="text" id="hide_reason" size="30">'}).dialog({resizable:false,modal:true,title:"",buttons:{"Да":function(){var d=$(this);var c=$("#hide_reason").val();$.ajax({url:"/BookSecretHide",data:"BookId="+b+"&HideReason="+c,success:function(e){var f=xsJsonParse(e);ReloadPage()}})},"Нет":function(){$(this).dialog("close")}}})})}$("[jq=BookAnnotationText]").xsTextHide({maxHeight:300,onHide:function(){if(!isScrolledIntoView($("[jq=BookAnnotationText]"))){jQuery.scrollTo($("[jq=BookAnnotationText]"),100,{offset:{top:-10}})}}})});function xsBookKeywordVote(){this.Init=function(){var b=this;var c='<div style="font-weight:bold; padding:5px; min-width: 230px; text-align:center; font-size:16px; font-size:1.6rem; "><table><tr><td style=" text-align:center; padding-bottom:5px;"> <span class="Click" jq="Remove" style="font-size:12px; font-size:1.2rem;">Удалить слово</span> </td></tr><tr><td style=" text-align:center; padding-bottom:5px;">Слово подходит к книге?</td></tr><tr><td style=" text-align:center; padding:0 10px 10px 10px; "><span class="Click" jq="up" style="color:green; text-decoration:none;">Подходит</span> <span  jq="Rating" style="min-width:40px; display:inline-block;"></span> <span class="Click" jq="down" style="color:red;  text-decoration:none;">Не подходит</span> </td></tr></table></div>';$("[jq=BookKeywords]").find("[jq=BookKeyword]").each(function(){var e=$(this);var d=e.attr("BookKeywordId");e.simpletip({fixed:true,position:"top",content:c,showEffect:"none",hideEffect:"none",onShow:function(){e.css("background-color","#FFF")},onHide:function(){e.css("background-color","transparent")}});e.find("[jq=Rating]").html(e.attr("Rating"));e.find("[jq=up]").click(function(){b.Vote(e,"up")});e.find("[jq=down]").click(function(){b.Vote(e,"down")});e.find("[jq=Remove]").click(function(){var f=$("<div />",{html:"Удалить ключевое слово?"}).dialog({autoOpen:true,resizable:false,modal:true,title:"Удалить ключевое слово",buttons:{"Удалить":function(){$.ajax({url:"/BookKeywordRemove",data:{BookKeywordId:d},success:function(g){var h=xsJsonParse(g);e.remove();f.dialog("close")}})},"Отмена":function(){f.dialog("close")}}})})})},this.Vote=function(e,d){var c=this;var b=e.attr("BookKeywordId");$.ajax({url:"/BookKeywordVote",data:{Vote:d,BookKeywordId:b},success:function(f){var g=xsJsonParse(f);e.find("[jq=Rating]").html(g.Rating);if(g.BookKeywordRemove){e.remove()}}})}}function xsBookKeywordAdd(){this.Init=function(){var b=this;$("[jq=BookKeywordAdd]").click(function(){b.Dialog=$("<div />",{html:'<div class="ui-widget"><label>Ключевое слово: </label><input jq="Keyword" style="width:200px"/><br /> Вводите по <b>одному</b> ключевому слову <b>за раз</b>!</div>'});b.Dialog.find("input[jq=Keyword]").autocomplete({source:"/KeywordShow.json",minLength:2,select:function(c,d){$(this).val(d.item.value)},search:function(c,d){}});b.Dialog.dialog({autoOpen:true,width:300,resizable:false,modal:true,title:"Добавить новое ключевое слово",buttons:{"Добавить":function(){b.AddKeyword()},"Отмена":function(){$(this).dialog("close")}}})})},this.AddKeyword=function(){var b=this;$.ajax({url:"/BookKeywordAdd",data:{Text:b.Dialog.find("input[jq=Keyword]").val(),BookId:xsJsDataGet("BookId")},success:function(c){var d=xsJsonParse(c);b.Dialog.dialog("close");$.ajax({url:"/BookKeywordsLoad",data:{BookId:xsJsDataGet("BookId")},success:function(e){var f=xsJsonParse(e);$("[jq=BookKeywords]").html(f.Content);new xsBookKeywordVote().Init()}})}})}}function DeleteFile(b){$("<div />",{html:"Вы действительно хотите удалить файл книги?"}).dialog({resizable:false,modal:true,title:"",buttons:{"Удалить":function(){var c=$(this);$.ajax({url:"/BookFileDelete",data:{BookFileId:b},success:function(f){var e=xsJsonParse(f);$("#FileItem"+b).remove();c.dialog("close")}})},"Нет":function(){$(this).dialog("close")}}})}function EditFile(b){$.ajax({url:"/BookFileEditForm",data:({BookFileId:b}),success:function(j){var h=xsJsonParse(j);var g=$("<div />",{html:h.Content});g.dialog({width:"640px",modal:true,resizable:false,title:"Редактировать описание файла книги",zIndex:3});var k=g.find("[jq=BookFileEditForm]");var i=k.find("[type=submit]");k.ajaxForm({url:"/BookFileEditSave",data:({BlogRecordId:b}),beforeSubmit:function(){i.attr("disabled","disabled")},error:function(){i.removeAttr("disabled")},success:function(e){var c=xsJsonParse(e);k.find("[jq=Output]").html(c.Content);$("#comment"+b).html(g.find("textarea").val());var d=new ViewFormErrors();d.Array=c.FormError;d.Container=k;d.Init();i.removeAttr("disabled");if(!d.IsErrorExists()){k.clearForm();g.dialog("close");a.Refresh()}}})}})}function addCutBook(b){$.ajax({url:"/addCutBook",data:"BookID="+b+"&key="+$.md5(Math.random()),success:function(f){var e=xsJsonParse(f);xsMessage("Создано")}})}function BookFb2FileConvertDivideOnPage(b){$("<div />",{html:"Вы действительно хотите преобразовать fb2 файл в страницы онлайн чтения?"}).dialog({resizable:false,modal:true,title:"",buttons:{"Да":function(){var c=$(this);$.ajax({url:"/BookFb2FileDivideOnPage",data:{BookFileId:b},success:function(f){var e=xsJsonParse(f);xsMessage("Создано");c.dialog("close")}})},"Нет":function(){$(this).dialog("close")}}})}function loadLitresData(b){$.ajax({url:"/loadLitresData",data:{BookID:b},success:function(g){var f=xsJsonParse(g);var e=f.Content.split("<error>");if(e.length>1){e=e[1].split("</error>");if(e.length>1){e=e[0];xsMessage(e)}else{xsMessage("Создано")}}else{xsMessage("Создано")}}})}function BookHideText(b){$.ajax({url:"/BookHideText",data:{BookID:b},success:function(d){xsMessage("Скрыто");location.reload()}})}function xsBookFiles(){this.Init=function(){var b=this;$("[jq=BookFiles]").find("[jq=BookFile]").each(function(){var c=new xsBookFileItem;c.Item=$(this);c.Init()})}}function xsBookFileItem(){this.Item;this.Init=function(){var b=this;b.BookFileId=b.Item.attr("BookFileId");b.Menu=b.Item.find(".jq-dropdown-menu");b.QRCode();b.Delete();b.DivideOnPage();b.Listen();b.Edit()};this.Refresh=function(){var b=this;$.ajax({url:"/LoadBookFiles",data:({BookId:xsJsDataGet("BookId")}),success:function(c){var d=xsJsonParse(c);$("[jq=BookFiles]").html(d.Content);new xsBookFiles().Init()}})};this.Edit=function(){var b=this;b.Menu.find("[jq=Edit]").click(function(){$.ajax({url:"/BookFileEditForm",data:({BookFileId:b.BookFileId}),success:function(e){var g=xsJsonParse(e);var c=$("<div />",{html:g.Content});c.dialog({width:"640px",modal:true,resizable:false,title:"Редактировать описание файла книги",zIndex:3});var d=c.find("[jq=BookFileEditForm]");var f=d.find("[type=submit]");d.ajaxForm({url:"/BookFileEditSave",data:({BlogRecordId:b.ItemId}),beforeSubmit:function(){f.attr("disabled","disabled")},error:function(){f.removeAttr("disabled")},success:function(h){var j=xsJsonParse(h);d.find("[jq=Output]").html(j.Content);var i=new ViewFormErrors();i.Array=j.FormError;i.Container=d;i.Init();f.removeAttr("disabled");if(!i.IsErrorExists()){d.clearForm();c.dialog("close");b.Refresh()}}})}})})};this.Listen=function(){var b=this;$("#Listen").click(function(){var i=$("[jq=BookFiles]").find("[jq=JplayerPattern]").html();if(b.Item.find("[jq=Player]").exists()){$("[jq=BookFiles]").find("[jq=Player]").remove();return}$("[jq=BookFiles]").find("[jq=Player]").remove();b.Item.append('<tr jq="Player"><td colspan="100%">'+i+"</td></tr>");b.Url=$("#download input[type=radio]:checked").val();var h=b.Item.find("[jq=jquery_jplayer]"),c,d,j,f,e={ready:function(k){if(k.jPlayer.status.noVolume){$(".jp-gui").addClass("jp-no-volume")}d=k.jPlayer.flash.used&&/m4a|m4v/.test(k.jPlayer.options.supplied);$(this).jPlayer("setMedia",{mp3:b.Url});$(this).jPlayer("play");if(localStorage.Vol){h.jPlayer("volume",parseFloat(localStorage.Vol))}},timeupdate:function(k){if(!f){g.progress.slider("value",k.jPlayer.status.currentPercentAbsolute)}},volumechange:function(k){if(k.jPlayer.options.muted){g.volume.slider("value",0)}else{g.volume.slider("value",k.jPlayer.options.volume)}localStorage.Vol=k.jPlayer.options.volume},swfPath:"/plugin/jPlayer-2.9.2/dist/jplayer/",supplied:"mp3, ogg",cssSelectorAncestor:"[jq=BookFile][BookFileId="+b.BookFileId+"]",wmode:"window"},g={progress:$(e.cssSelectorAncestor+" .jp-progress-slider"),volume:$(e.cssSelectorAncestor+" .jp-volume-slider")};h.jPlayer(e);c=h.data("jPlayer");$(".jp-gui ul li").hover(function(){$(this).addClass("ui-state-hover")},function(){$(this).removeClass("ui-state-hover")});g.progress.slider({animate:"fast",max:100,range:"min",step:0.1,value:0,slide:function(k,m){var l=c.status.seekPercent;if(l>0){if(d){f=true;clearTimeout(j);j=setTimeout(function(){f=false},1000)}h.jPlayer("playHead",m.value*(100/l))}else{setTimeout(function(){g.progress.slider("value",0)},0)}}});g.volume.slider({animate:"fast",max:1,range:"min",step:0.01,value:$.jPlayer.prototype.options.volume,slide:function(k,l){h.jPlayer("option","muted",false);h.jPlayer("option","volume",l.value)}});return false})};this.QRCode=function(){var b=this;var c=b.Item.find("[jq=QRCodeGet]");var d=c.attr("href");c.removeAttr("href").click(function(){$("<div />",{html:'<img src="'+d+'" />'}).dialog({title:"QR код ссылки на скачивание файла",width:"800",position:{my:"center top+130",at:"top",of:window},resizable:true,modal:true,})})};this.Delete=function(){var b=this;b.Menu.find("[jq=Delete]").click(function(){$("<div />",{html:"Вы действительно хотите удалить файл книги?"}).dialog({resizable:false,modal:true,title:"",buttons:{"Удалить":function(){var c=$(this);$.ajax({url:"/BookFileDelete",data:{BookFileId:b.BookFileId},success:function(d){var e=xsJsonParse(d);b.Item.parent("div").remove();b.Refresh();c.dialog("close")}})},"Нет":function(){$(this).dialog("close")}}})})};this.DivideOnPage=function(){var b=this;b.Menu.find("[jq=BookFb2FileConvertDivideOnPage]").click(function(){$("<div />",{html:"Вы действительно хотите преобразовать fb2 файл в страницы онлайн чтения?"}).dialog({resizable:false,modal:true,title:"",buttons:{"Да":function(){var c=$(this);$.ajax({url:"/BookFb2FileDivideOnPage",data:{BookFileId:b.BookFileId},success:function(d){var e=xsJsonParse(d);xsMessage("Создано");c.dialog("close")}})},"Нет":function(){$(this).dialog("close")}}})})}}function xsBookVote(){this.Init=function(){var self=this;var BookId=xsJsDataGet("BookId");self.ShowRateRemoveIfRateExists();var BookRates=$("[jq=BookRates]").buttonset();$("[jq=BookRates] :radio").click(function(){var Rate=$(this).val();$.ajax({url:"/vote_for_book",type:"GET",data:({BookId:BookId,Rate:Rate}),success:function(Str){var data=xsJsonParse(Str);$("[jq=rate_status]").html(""+data.Time+"");$("[jq=book_rating]").html(data.BookRating);$("[jq=UserVoteCount]").html("<b>Пользователи, оценившие книгу:</b>&nbsp;"+data.UserVoteCount+"");self.ShowRateRemoveIfRateExists()}})});$("[jq=RateRemove]").click(function(){$.ajax({url:"/BookRateRemove",data:({BookId:BookId}),success:function(Str){var data=xsJsonParse(Str);$("[jq=book_rating]").html(data.BookRating);$("[jq=rate_status]").html("");$("[jq=UserVoteCount]").html("<b>Пользователи, оценившие книгу:</b>&nbsp;"+data.UserVoteCount+"");BookRates.find("input:checked").removeAttr("checked");BookRates.buttonset("refresh");self.ShowRateRemoveIfRateExists()}})});$("[jq=VoteStat]").find("tr").each(function(){var Parent=$(this);var Percent=Parent.find("[jq=Percent]").text();var ProgressBar=Parent.find("[jq=ProgressBars]");ProgressBar.progressbar();ProgressBar.progressbar("value",eval(Percent))});$("[jq=VoteStatAccordion]").accordion({collapsible:true,active:false,heightStyle:"content",animate:false})};this.IsRateExists=function(){var self=this;if($("[jq=BookRates]").find("input:checked").exists()){return true}else{return false}};this.ShowRateRemoveIfRateExists=function(){var self=this;if(self.IsRateExists()){$("[jq=RateRemove]").show()}else{$("[jq=RateRemove]").hide()}}}function xsBookCover(){this.Init=function(){var b=this;var c=xsJsDataGet("BookId");$("[jq=BookCover]").css("cursor","pointer").click(function(){$.ajax({url:"/BookFullPhoto",data:({BookId:c}),success:function(i){var j=xsJsonParse(i);var h=$(window).width();var f=$(window).height();var g=j.Width;var d=j.Height;var k=ImageFit(f-100,h-100,d,g);var e=$("<div />").html('<img alt="'+j.Alt+'" style="width:'+k[0]+"px; height:"+k[1]+'px;" src="'+j.Url+'" />');e.dialog({modal:true,title:"",autoOpen:true,resize:false,width:k[0]+35,height:k[1]+60,open:function(l,m){}})}})})}}function xsBookReadContinue(){this.Init=function(){var b=this;var c=xsJsDataGet("BookId");$("[jq=ButtonBookReadComplete]").css("cursor","pointer").click(function(){$.ajax({url:"/BookPageRememberRemove",data:({BookId:c}),success:function(d){var e=xsJsonParse(d);$("[jq=ReadContinue]").remove()}})})}};